Redoing all network code, better structure
